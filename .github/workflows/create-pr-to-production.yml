# When a PR is merged into staging, open a PR from staging → main (production) with the same title and body.
# Uses GH_PAT (Personal Access Token) because GITHUB_TOKEN is often blocked from creating PRs
# even when "Allow GitHub Actions to create and approve pull requests" is enabled.
# Add secret: Settings → Secrets and variables → Actions → GH_PAT (PAT with repo scope).
name: Create PR to Production

on:
  pull_request:
    types: [closed]

jobs:
  create-production-pr:
    name: Open PR (staging → main)
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'staging'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Require GH_PAT
        run: |
          if [ -z "${{ secrets.GH_PAT }}" ]; then
            echo "::error::Add repo secret GH_PAT. Settings → Secrets and variables → Actions → New repository secret. Create a PAT at GitHub → Settings → Developer settings → Personal access tokens (scope: repo)."
            exit 1
          fi
      - name: Create PR from staging to main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            const title = context.payload.pull_request.title;
            const body = context.payload.pull_request.body || title || '';
            const { data } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              head: 'staging',
              base: 'main'
            });
            core.notice(`Created PR #${data.number}: ${data.html_url}`);

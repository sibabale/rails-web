# When a PR is merged: open a PR to the next environment (develop→staging or staging→main).
# Only one job runs per event: merged into develop → create PR to staging; merged into staging → create PR to main.
# Uses GH_PAT (PAT with repo scope). Add secret: Settings → Secrets and variables → Actions → GH_PAT.
name: Create PR to Next Environment

on:
  pull_request:
    types: [closed]

jobs:
  create-staging-pr:
    name: Open PR (develop → staging)
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'develop'
    runs-on: ubuntu-latest
    env:
      GH_PAT: ${{ secrets.GH_PAT }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Require GH_PAT
        run: |
          if [ -z "$GH_PAT" ]; then
            echo "::error::Add repo secret GH_PAT. Settings → Secrets and variables → Actions → New repository secret. Create a PAT at GitHub → Settings → Developer settings → Personal access tokens (scope: repo)."
            exit 1
          fi
      - name: Create PR from develop to staging
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GH_PAT }}
          script: |
            const title = context.payload.pull_request.title;
            const body = context.payload.pull_request.body || title || '';
            try {
              const { data } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                head: 'develop',
                base: 'staging'
              });
              core.notice(`Created PR #${data.number}: ${data.html_url}`);
            } catch (err) {
              if (err.status === 422) {
                const { data: existing } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  head: 'develop',
                  base: 'staging'
                });
                if (existing.length > 0) {
                  core.notice(`PR from develop to staging already exists: #${existing[0].number} ${existing[0].html_url}`);
                } else {
                  core.notice('A PR from develop to staging already exists.');
                }
              } else {
                throw err;
              }
            }

  create-production-pr:
    name: Open PR (staging → main)
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'staging'
    runs-on: ubuntu-latest
    env:
      GH_PAT: ${{ secrets.GH_PAT }}
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Require GH_PAT
        run: |
          if [ -z "$GH_PAT" ]; then
            echo "::error::Add repo secret GH_PAT. Settings → Secrets and variables → Actions → New repository secret. Create a PAT at GitHub → Settings → Developer settings → Personal access tokens (scope: repo)."
            exit 1
          fi
      - name: Create PR from staging to main
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.GH_PAT }}
          script: |
            const title = context.payload.pull_request.title;
            const body = context.payload.pull_request.body || title || '';
            try {
              const { data } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                head: 'staging',
                base: 'main'
              });
              core.notice(`Created PR #${data.number}: ${data.html_url}`);
            } catch (err) {
              if (err.status === 422) {
                const { data: existing } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  head: 'staging',
                  base: 'main'
                });
                if (existing.length > 0) {
                  core.notice(`PR from staging to main already exists: #${existing[0].number} ${existing[0].html_url}`);
                } else {
                  core.notice('A PR from staging to main already exists.');
                }
              } else {
                throw err;
              }
            }
